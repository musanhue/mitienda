<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Por Su Pollo - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-brand { font-family: 'Lilita One', cursive; }
        .view { display: none; }
        .view.active { display: block; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #fff7ed; }
        ::-webkit-scrollbar-thumb { background: #fb923c; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f97316; }
        #camera-view {
            width: 100%;
            max-width: 400px;
            aspect-ratio: 4 / 3;
            object-fit: cover;
            border-radius: 0.5rem;
            background-color: #000;
        }
        .nav-link.active {
            color: #f97316;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-orange-50 text-amber-900">

    <header class="bg-white shadow-lg sticky top-0 z-50">
        <nav class="container mx-auto px-4 lg:px-6 py-2">
            <div class="flex items-center justify-between">
                <a href="#" class="flex items-center space-x-3">
                    <img id="header-logo" src="https://firebasestorage.googleapis.com/v0/b/mitienda-afb9a.appspot.com/o/WhatsApp%20Image%202025-08-26%20at%2010.30.35.jpeg?alt=media&token=446c962a-b2e7-4618-867f-c9cb7f258acc" alt="Logo Por Su Pollo" class="h-12 w-auto">
                    <span class="text-2xl font-brand text-amber-800">Admin Panel</span>
                </a>
                <div class="hidden md:flex items-center space-x-6 font-brand text-lg">
                    <a href="#productos" class="nav-link text-amber-700 hover:text-orange-500 transition duration-300">Productos ğŸ—</a>
                    <a href="#pagos" class="nav-link text-amber-700 hover:text-orange-500 transition duration-300">Pagos ğŸ’°</a>
                    <a href="#entregas" class="nav-link text-amber-700 hover:text-orange-500 transition duration-300">Entregas ğŸ›µ</a>
                    <a href="#resumen" class="nav-link text-amber-700 hover:text-orange-500 transition duration-300">Resumen ğŸ“ˆ</a>
                </div>
                <button id="mobile-menu-button" class="md:hidden text-orange-500 text-2xl">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <div id="mobile-menu" class="hidden md:hidden mt-4 font-brand text-lg">
                <a href="#productos" class="nav-link block py-2 text-amber-700 hover:text-orange-500">Productos ğŸ—</a>
                <a href="#pagos" class="nav-link block py-2 text-amber-700 hover:text-orange-500">Pagos ğŸ’°</a>
                <a href="#entregas" class="nav-link block py-2 text-amber-700 hover:text-orange-500">Entregas ğŸ›µ</a>
                <a href="#resumen" class="nav-link block py-2 text-amber-700 hover:text-orange-500">Resumen ğŸ“ˆ</a>
            </div>
        </nav>
    </header>

    <main class="container mx-auto p-4 lg:p-6">
        <section id="productos-view" class="view">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <h1 class="text-4xl font-brand text-amber-800">AdministraciÃ³n de Productos</h1>
                <button id="add-product-btn" class="w-full sm:w-auto bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition duration-300 font-brand text-xl shadow-md">
                    <i class="fas fa-plus mr-2"></i>Agregar Pollo
                </button>
            </div>
            <div id="admin-product-list" class="bg-white p-4 rounded-lg shadow-lg space-y-4 max-h-[70vh] overflow-y-auto"></div>
        </section>

        <section id="pagos-view" class="view">
             <h1 class="text-4xl font-brand text-amber-800 mb-6">GestiÃ³n de Pagos ğŸ’°</h1>
             <h2 class="text-2xl font-brand text-amber-700 mb-4">Pedidos Pendientes de Pago</h2>
             <div id="pending-payment-list" class="bg-white p-4 rounded-lg shadow-lg space-y-4 max-h-[70vh] overflow-y-auto"></div>
        </section>

        <section id="entregas-view" class="view">
            <h1 class="text-4xl font-brand text-amber-800 mb-6">GestiÃ³n de Entregas ğŸ›µ</h1>
             <h2 class="text-2xl font-brand text-amber-700 mb-4">Pedidos Pendientes de Entrega</h2>
            <div id="pending-delivery-list" class="bg-white p-4 rounded-lg shadow-lg space-y-4"></div>
        </section>

        <section id="resumen-view" class="view">
            <h1 class="text-4xl font-brand text-amber-800 mb-6">Resumen General ğŸ“ˆ</h1>
            <div id="summary-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                 <div class="bg-gray-200 p-4 rounded-lg shadow animate-pulse h-28"></div>
                 <div class="bg-gray-200 p-4 rounded-lg shadow animate-pulse h-28"></div>
                 <div class="bg-gray-200 p-4 rounded-lg shadow animate-pulse h-28"></div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-lg overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="font-brand">
                        <tr class="bg-orange-100">
                            <th class="p-3">NÂ° Pedido</th> <th class="p-3">Fecha</th> <th class="p-3">Total</th> <th class="p-3">Estado</th> <th class="p-3">Detalle</th>
                        </tr>
                    </thead>
                    <tbody id="all-orders-list"></tbody>
                </table>
            </div>
        </section>
    </main>

    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-[60] p-4">
        <div class="bg-orange-50 p-6 rounded-lg shadow-xl w-full max-w-md max-h-full overflow-y-auto">
            <h2 id="modal-title" class="text-3xl font-brand mb-6 text-amber-800">Agregar Producto</h2>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="mb-4">
                    <label for="product-name" class="block text-sm font-medium text-amber-800">Nombre del Plato ğŸ—</label>
                    <input type="text" id="product-name" class="mt-1 block w-full p-2 border-orange-200 border rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500" required>
                </div>
                <div class="mb-4">
                    <label for="product-description" class="block text-sm font-medium text-amber-800">DescripciÃ³n ğŸ“</label>
                    <textarea id="product-description" rows="3" class="mt-1 block w-full p-2 border-orange-200 border rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500"></textarea>
                </div>
                <div class="mb-4">
                    <label for="product-price" class="block text-sm font-medium text-amber-800">Precio ğŸ’²</label>
                    <input type="number" id="product-price" min="0" class="mt-1 block w-full p-2 border-orange-200 border rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-amber-800">Foto del Plato ğŸ“¸</label>
                    <img id="image-preview" class="mt-2 w-full rounded-md object-cover h-48 hidden bg-orange-100 border-2 border-dashed border-orange-300">
                    <input type="file" id="image-file-input" class="hidden" accept="image/*">
                    <div class="flex space-x-2 mt-2">
                        <button type="button" id="select-file-btn" class="w-full bg-orange-200 text-orange-800 px-4 py-2 rounded-md hover:bg-orange-300 font-semibold"><i class="fas fa-upload mr-2"></i>Examinar</button>
                        <button type="button" id="use-camera-btn" class="w-full bg-orange-200 text-orange-800 px-4 py-2 rounded-md hover:bg-orange-300 font-semibold"><i class="fas fa-camera mr-2"></i>CÃ¡mara</button>
                    </div>
                </div>
                <div id="camera-container" class="hidden mb-4">
                    <video id="camera-view" autoplay playsinline></video>
                    <canvas id="camera-canvas" class="hidden"></canvas>
                    <div class="flex space-x-2 mt-2">
                         <button type="button" id="capture-btn" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 font-semibold"><i class="fas fa-camera-retro mr-2"></i>Capturar</button>
                         <button type="button" id="cancel-camera-btn" class="w-full bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 font-semibold"><i class="fas fa-times mr-2"></i>Cancelar</button>
                    </div>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-product-modal" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 font-semibold">Cancelar</button>
                    <button type="submit" class="bg-orange-500 text-white px-4 py-2 rounded-md hover:bg-orange-600 font-brand text-lg" id="save-product-btn">
                        <span id="save-spinner" class="hidden"><i class="fas fa-spinner fa-spin"></i></span>
                        <span id="save-text">Guardar</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, getDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDuRkOZ6cSt1ScnqYbn9EnQeYXUCofDYHc",
          authDomain: "mitienda-afb9a.firebaseapp.com",
          projectId: "mitienda-afb9a",
          storageBucket: "mitienda-afb9a.firebasestorage.app",
          messagingSenderId: "551425772249"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        const productCollection = collection(db, 'products');
        const orderCollection = collection(db, 'orders');

        const views = document.querySelectorAll('.view');
        const navLinks = document.querySelectorAll('.nav-link');
        let currentImageFile = null;
        let cameraStream = null;

        function formatPrice(number) {
            if (typeof number !== 'number') number = Number(number) || 0;
            return Math.round(number).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function showView(hash) {
            const id = (hash || '#productos').substring(1) + '-view';
            views.forEach(view => view.classList.toggle('active', view.id === id));
            navLinks.forEach(link => {
                const linkHash = new URL(link.href).hash;
                link.classList.toggle('active', linkHash === (hash || '#productos'));
            })
        }

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Signed in anonymously:", user.uid);
                initializePage();
            } else {
                console.log("User is signed out. Attempting to sign in anonymously.");
                signInAnonymously(auth).catch((error) => {
                    console.error("Anonymous sign-in failed:", error);
                    alert("No se pudo conectar con el servidor. Por favor, refresca la pÃ¡gina.");
                });
            }
        });

        function initializePage() {
            showView(window.location.hash || '#productos');
            fetchAdminProducts();
            listenToOrders();
        }

        window.addEventListener('hashchange', () => showView(window.location.hash));
        
        document.getElementById('mobile-menu-button').addEventListener('click', () => {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        });

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const hash = new URL(link.href).hash;
                window.location.hash = hash;
                if(document.getElementById('mobile-menu').classList.contains('hidden') === false){
                   document.getElementById('mobile-menu').classList.add('hidden');
                }
            });
        });

        function fetchAdminProducts() {
            const q = query(productCollection, orderBy('name'));
            onSnapshot(q, (snapshot) => {
                const adminProductList = document.getElementById('admin-product-list');
                adminProductList.innerHTML = '';
                 if(snapshot.empty) {
                     adminProductList.innerHTML = `<p class="text-center text-amber-700 font-brand text-2xl py-10">ğŸ— Â¡AÃºn no hay pollos en el menÃº! ğŸ—</p>`;
                }
                snapshot.docs.forEach(doc => {
                    const product = { id: doc.id, ...doc.data() };
                    adminProductList.innerHTML += `
                        <div class="flex items-center justify-between p-3 border-b border-orange-100">
                            <div class="flex items-center min-w-0">
                                <img src="${product.imageUrl || 'https://placehold.co/100/fed7aa/f97316?text=ğŸ—'}" class="w-16 h-16 object-cover rounded-md mr-4" onerror="this.onerror=null;this.src='https://placehold.co/100/fed7aa/f97316?text=ğŸ—';">
                                <div class="truncate">
                                    <p class="font-semibold truncate text-amber-800">${product.name}</p>
                                    <p class="text-sm text-orange-600 font-bold">$${formatPrice(product.price || 0)}</p>
                                </div>
                            </div>
                            <div class="space-x-3 flex-shrink-0">
                                <button class="edit-product-btn text-blue-500 hover:text-blue-700 text-xl" data-id="${product.id}"><i class="fas fa-edit"></i></button>
                                <button class="delete-product-btn text-red-500 hover:text-red-700 text-xl" data-id="${product.id}"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                });
            });
        }
        
        const productModal = document.getElementById('product-modal');
        const productForm = document.getElementById('product-form');
        const imagePreview = document.getElementById('image-preview');

        function resetProductModal() {
            productForm.reset();
            document.getElementById('product-id').value = '';
            imagePreview.src = '';
            imagePreview.classList.add('hidden');
            currentImageFile = null;
            stopCamera();
            document.getElementById('camera-container').classList.add('hidden');
            toggleSaveButton(false);
        }

        document.getElementById('add-product-btn').addEventListener('click', () => {
            resetProductModal();
            document.getElementById('modal-title').textContent = 'Agregar Producto';
            productModal.classList.remove('hidden');
        });

        document.getElementById('cancel-product-modal').addEventListener('click', () => productModal.classList.add('hidden'));
        document.getElementById('select-file-btn').addEventListener('click', () => document.getElementById('image-file-input').click());
        
        async function processImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const maxWidth = 1024;
                        if (img.width <= maxWidth) {
                             resolve(event.target.result);
                             return;
                        }
                        const scaleFactor = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scaleFactor;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = (err) => reject(new Error("Error loading image: " + err));
                    img.src = event.target.result;
                };
                reader.onerror = (err) => reject(new Error("Error reading file: " + err));
                reader.readAsDataURL(file);
            });
        }

        document.getElementById('image-file-input').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                try {
                    const dataUrl = await processImage(file);
                    currentImageFile = dataUrl;
                    imagePreview.src = dataUrl;
                    imagePreview.classList.remove('hidden');
                    stopCamera();
                } catch (error) { 
                    console.error("Error processing image:", error);
                    alert("Hubo un error al procesar la imagen. Intenta con otra.");
                }
            }
        });

        document.getElementById('use-camera-btn').addEventListener('click', async () => {
            document.getElementById('camera-container').classList.remove('hidden');
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
                document.getElementById('camera-view').srcObject = cameraStream;
            } catch (err) { 
                console.error("Error accessing camera: ", err); 
                alert('No se pudo acceder a la cÃ¡mara. AsegÃºrate de dar los permisos necesarios.');
                document.getElementById('camera-container').classList.add('hidden'); 
            }
        });

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                document.getElementById('camera-container').classList.add('hidden');
            }
        }
        document.getElementById('cancel-camera-btn').addEventListener('click', stopCamera);

        document.getElementById('capture-btn').addEventListener('click', async () => {
            const video = document.getElementById('camera-view');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
            currentImageFile = dataUrl;
            imagePreview.src = dataUrl;
            imagePreview.classList.remove('hidden');
            stopCamera();
        });

        function toggleSaveButton(isLoading) {
            document.getElementById('save-text').classList.toggle('hidden', isLoading);
            document.getElementById('save-spinner').classList.toggle('hidden', !isLoading);
            document.getElementById('save-product-btn').disabled = isLoading;
        }

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleSaveButton(true);
            
            let imageUrl = document.getElementById('image-preview').src;
            if (imageUrl.startsWith('blob:') || imageUrl.startsWith('data:image') || imageUrl.startsWith('https://placehold.co')) {
                 imageUrl = '';
            }
            
            if (currentImageFile) {
                try {
                    const storageRef = ref(storage, `products/${Date.now()}.jpg`);
                    const snapshot = await uploadString(storageRef, currentImageFile, 'data_url');
                    imageUrl = await getDownloadURL(snapshot.ref);
                } catch (storageError) {
                    console.error("Firebase Storage error:", storageError);
                    alert(`ERROR: No se pudo subir la imagen. Por favor, asegÃºrate de que las reglas de seguridad de Firebase Storage estÃ©n configuradas como 'allow read, write;'. CÃ³digo de error: ${storageError.code}`);
                    toggleSaveButton(false);
                    return;
                }
            }

            const productId = document.getElementById('product-id').value;
            const productData = {
                name: document.getElementById('product-name').value,
                description: document.getElementById('product-description').value,
                price: parseFloat(document.getElementById('product-price').value) || 0,
            };

            if (imageUrl) {
                productData.imageUrl = imageUrl;
            } else if (productId) { 
                const docRef = doc(db, 'products', productId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists() && docSnap.data().imageUrl) {
                    productData.imageUrl = docSnap.data().imageUrl;
                }
            }

            try {
                if (productId) {
                    await updateDoc(doc(db, 'products', productId), productData);
                } else {
                    await addDoc(productCollection, productData);
                }
                productModal.classList.add('hidden');
                resetProductModal();
            } catch (error) {
                console.error("Error saving product to Firestore:", error);
                alert("Hubo un error al guardar los datos del producto.");
            } finally {
                toggleSaveButton(false);
            }
        });

        document.getElementById('admin-product-list').addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-product-btn');
            const deleteBtn = e.target.closest('.delete-product-btn');
            if (editBtn) {
                resetProductModal();
                const id = editBtn.dataset.id;
                const productSnap = await getDoc(doc(db, 'products', id));
                if (productSnap.exists()) {
                    const product = productSnap.data();
                    document.getElementById('product-id').value = id;
                    document.getElementById('product-name').value = product.name || '';
                    document.getElementById('product-description').value = product.description || '';
                    document.getElementById('product-price').value = product.price || '';
                    if (product.imageUrl) {
                        imagePreview.src = product.imageUrl;
                        imagePreview.classList.remove('hidden');
                    }
                    document.getElementById('modal-title').textContent = 'Editar Producto';
                    productModal.classList.remove('hidden');
                }
            }
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                const productSnap = await getDoc(doc(db, 'products', id));
                 if (confirm('Â¿Seguro que quieres eliminar este producto? ğŸ”')) {
                    if (productSnap.exists() && productSnap.data().imageUrl) {
                        try {
                            const imageRef = ref(storage, productSnap.data().imageUrl);
                            await deleteObject(imageRef);
                        } catch (error) {
                            console.error("Could not delete image, but proceeding with doc deletion:", error.code);
                            if(error.code === 'storage/object-not-found'){
                                console.log("Image not found in storage, might have been deleted already.");
                            } else {
                                alert("No se pudo eliminar la imagen, pero se eliminarÃ¡ el producto.");
                            }
                        }
                    }
                    await deleteDoc(doc(db, 'products', id));
                }
            }
        });

        function listenToOrders() {
            const q = query(orderCollection, orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                const pendingPaymentList = document.getElementById('pending-payment-list');
                const pendingDeliveryList = document.getElementById('pending-delivery-list');
                const allOrdersList = document.getElementById('all-orders-list');
                
                pendingPaymentList.innerHTML = '';
                pendingDeliveryList.innerHTML = '';
                allOrdersList.innerHTML = '';
                
                let hasPendingPayments = false, hasPendingDeliveries = false;

                let summary = {
                    'Pendiente de Pago': { count: 0, total: 0 },
                    'Pendiente de Entrega': { count: 0, total: 0 },
                    'Entregado': { count: 0, total: 0 }
                };

                snapshot.docs.forEach(doc => {
                    const order = { id: doc.id, ...doc.data() };
                    const orderDate = order.createdAt?.toDate().toLocaleString('es-CL') || 'N/A';
                    
                    if (summary[order.status]) {
                        summary[order.status].count++;
                        summary[order.status].total += order.total;
                    }

                    const orderCardHtml = (statusAction, btnText, btnColor, btnIcon) => `
                        <div class="bg-orange-50 p-4 rounded-md border border-orange-200">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold font-brand text-lg">Pedido #${order.orderNumber}</p>
                                    <p class="text-sm text-gray-500">${orderDate}</p>
                                    <p class="font-semibold text-xl my-2 text-orange-600">$${formatPrice(order.total)}</p>
                                </div>
                                <button class="${btnColor} text-white px-3 py-2 rounded-md text-sm font-semibold update-status-btn" data-id="${order.id}" data-status="${statusAction}">
                                    <i class="fas ${btnIcon} mr-2"></i>${btnText}
                                </button>
                            </div>
                            <details class="text-sm mt-2"><summary class="cursor-pointer text-orange-600 font-semibold">Ver detalle</summary><div class="mt-2 pl-4 border-l-2 border-orange-200">${order.items.map(item => `<p>${item.quantity} x ${item.productName}</p>`).join('')}</div></details>
                        </div>`;

                     allOrdersList.innerHTML += `
                        <tr class="border-b border-orange-100 hover:bg-orange-50">
                            <td class="p-3 font-mono">#${order.orderNumber}</td> <td class="p-3">${orderDate}</td> <td class="p-3 font-semibold">$${formatPrice(order.total)}</td>
                            <td class="p-3"><span class="px-2 py-1 text-xs rounded-full font-semibold ${getStatusClass(order.status).bg} ${getStatusClass(order.status).text}">${order.status}</span></td>
                            <td class="p-3"><details><summary class="cursor-pointer text-orange-600 text-sm font-semibold">Ver</summary><div class="text-xs mt-1">${order.items.map(item => `<p>${item.quantity} x ${item.productName}</p>`).join('')}</div></details></td>
                        </tr>`;

                    if (order.status === 'Pendiente de Pago') {
                        hasPendingPayments = true;
                        pendingPaymentList.innerHTML += orderCardHtml('Pendiente de Entrega', 'Marcar Pagado', 'bg-blue-500 hover:bg-blue-600', 'fa-check');
                    } else if (order.status === 'Pendiente de Entrega') {
                        hasPendingDeliveries = true;
                        pendingDeliveryList.innerHTML += orderCardHtml('Entregado', 'Marcar Entregado', 'bg-yellow-500 hover:bg-yellow-600', 'fa-truck');
                    }
                });

                const summaryCardsContainer = document.getElementById('summary-cards');
                summaryCardsContainer.innerHTML = `
                    <div class="bg-red-100 p-4 rounded-lg shadow-md border-l-4 border-red-500">
                        <h3 class="font-semibold text-red-800 font-brand text-xl">Pendiente de Pago ğŸ’°</h3>
                        <p class="text-3xl font-bold text-red-900">${summary['Pendiente de Pago'].count} pedidos</p>
                        <p class="text-xl font-semibold text-red-900">$${formatPrice(summary['Pendiente de Pago'].total)}</p>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-lg shadow-md border-l-4 border-yellow-500">
                        <h3 class="font-semibold text-yellow-800 font-brand text-xl">Pendiente de Entrega ğŸ³</h3>
                        <p class="text-3xl font-bold text-yellow-900">${summary['Pendiente de Entrega'].count} pedidos</p>
                        <p class="text-xl font-semibold text-yellow-900">$${formatPrice(summary['Pendiente de Entrega'].total)}</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg shadow-md border-l-4 border-green-500">
                        <h3 class="font-semibold text-green-800 font-brand text-xl">Entregado ğŸ‰</h3>
                        <p class="text-3xl font-bold text-green-900">${summary['Entregado'].count} pedidos</p>
                        <p class="text-xl font-semibold text-green-900">$${formatPrice(summary['Entregado'].total)}</p>
                    </div>
                `;

                if (!hasPendingPayments) pendingPaymentList.innerHTML = '<p class="text-amber-700 text-center p-4 font-brand text-2xl">Â¡Todo pagado! âœ…</p>';
                if (!hasPendingDeliveries) pendingDeliveryList.innerHTML = '<p class="text-amber-700 text-center p-4 font-brand text-2xl">Â¡No hay pollos esperando! ğŸšš</p>';
            });
        }
        
        document.body.addEventListener('click', async e => {
            if (e.target.closest('.update-status-btn')) {
                const id = e.target.closest('.update-status-btn').dataset.id;
                const newStatus = e.target.closest('.update-status-btn').dataset.status;
                await updateDoc(doc(db, 'orders', id), { status: newStatus });
            }
        });

        function getStatusClass(status) {
            switch(status) {
                case 'Pendiente de Pago': return { bg: 'bg-red-200', text: 'text-red-800' };
                case 'Pendiente de Entrega': return { bg: 'bg-yellow-200', text: 'text-yellow-800' };
                case 'Entregado': return { bg: 'bg-green-200', text: 'text-green-800' };
                default: return { bg: 'bg-gray-200', text: 'text-gray-800' };
            }
        }
    </script>
</body>
</html>

